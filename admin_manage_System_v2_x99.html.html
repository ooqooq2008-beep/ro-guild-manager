<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RO å·¥æœƒç®¡ç†ç³»çµ± - é›²ç«¯å°ˆç”¨ç‰ˆ</title>
    <style>
        /* --- å…¨åŸŸèˆ‡ RO é¢¨æ ¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1a1a1a; background-image: radial-gradient(circle, #2c3e50, #000000); color: #e0e0e0; margin: 20px; }
        .ro-panel { background: rgba(30, 30, 30, 0.95); border: 2px solid #cfaa70; border-radius: 10px; padding: 20px; box-shadow: 0 0 15px rgba(207, 170, 112, 0.3); max-width: 1200px; margin: 0 auto; min-height: 700px; position: relative; }
        h2 { color: #ffde9e; text-align: center; border-bottom: 1px solid #cfaa70; padding-bottom: 10px; margin-top: 0; }
        
        /* è®€å–é®ç½© */
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px; }
        .loading-spinner { border: 5px solid #f3f3f3; border-top: 5px solid #cfaa70; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tab-container { display: flex; margin-bottom: 20px; border-bottom: 2px solid #555; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; background: #2a2a2a; border: 1px solid #555; border-bottom: none; color: #aaa; cursor: pointer; font-weight: bold; border-radius: 5px 5px 0 0; margin-right: 5px; white-space: nowrap; }
        .tab-btn:hover { background: #333; color: #fff; }
        .tab-btn.active { background: #4a90e2; color: #fff; border-color: #8abeff; }
        .tab-btn-add { background: #2ecc71; color: #fff; border-color: #27ae60; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* çµ±è¨ˆå„€è¡¨æ¿æ¨£å¼ */
        .stats-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .stat-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #000;
            font-weight: bold;
            display: flex;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .stat-total {
            background: #f1c40f;
            color: #000;
            font-size: 1.1em;
            margin-right: 15px;
            border: 1px solid #f39c12;
        }

        /* è¼¸å…¥å€å¡Šæ¨£å¼ */
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; align-items: flex-end; border: 1px solid #444; }
        .input-item { display: flex; flex-direction: column; }
        label { font-size: 0.8em; color: #aaa; margin-bottom: 5px; }
        input[type="text"], input[type="number"], select { padding: 8px; background: #2a2a2a; border: 1px solid #555; color: #fff; border-radius: 4px; outline: none; }
        .force-input { width: 60px; text-align: center; background: #111; border: 1px solid #555; color: #ffde9e; font-weight: bold; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .ro-btn { padding: 8px 20px; background: linear-gradient(180deg, #4a90e2, #0056b3); color: white; border: 1px solid #8abeff; border-radius: 4px; cursor: pointer; font-weight: bold; min-width: 80px; }
        .ro-btn:hover { filter: brightness(1.1); }
        .ro-btn:disabled { background: #555; border-color: #444; color: #888; cursor: not-allowed; filter: none; }
        .btn-delete { background: linear-gradient(180deg, #c0392b, #8e2a20); border-color: #e74c3c; }
        .btn-add-team { background: linear-gradient(180deg, #2ecc71, #27ae60); border-color: #2ecc71; margin-bottom: 10px;}
        .btn-move { padding: 2px 8px; background: #333; border: 1px solid #555; color: #fff; font-size: 0.8em; cursor: pointer; }
        .btn-submit-leave { background: linear-gradient(180deg, #f39c12, #d35400); border-color: #e67e22; color: #000; }
        .btn-refresh { background: linear-gradient(180deg, #9b59b6, #8e44ad); border-color: #9b59b6; margin-left: 10px; }
        .btn-card-delete { background: #c0392b; color: #fff; border: 1px solid #e74c3c; border-radius: 4px; cursor: pointer; padding: 4px 8px; font-size: 0.8em; margin-left: 10px; }
        .btn-card-delete:hover { background: #e74c3c; }
        .btn-promote { background: linear-gradient(180deg, #27ae60, #2ecc71); border-color: #2ecc71; color: #fff; }
        
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #444; }
        .filter-btn { padding: 5px 12px; border: 1px solid #555; background: #222; color: #888; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
        .filter-btn.active { background: #cfaa70; color: #000; font-weight: bold; border-color: #fff; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; color: #ddd; }
        th { background: linear-gradient(180deg, #3d3d3d, #222); color: #ffde9e; padding: 12px; cursor: pointer; border-bottom: 2px solid #cfaa70; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #444; background: rgba(0, 0, 0, 0.2); vertical-align: middle; }
        .editable { cursor: text; }
        .editable:focus { background: #000; border: 1px solid #cfaa70; outline: none; }
        .center-col { text-align: center; }
        .job-text { font-weight: bold; text-shadow: 1px 1px 2px #000; }
        
        /* å‡å–®å°ˆç”¨ */
        .leave-dashboard { display: flex; gap: 20px; min-height: 500px; margin-top: 10px; }
        .leave-date-list { flex: 1; background: rgba(0,0,0,0.3); border-right: 1px solid #444; padding: 10px; overflow-y: auto; max-height: 600px; }
        .date-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 8px; background: #2a2a2a; border: 1px solid #444; color: #ddd; cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; justify-content: space-between; }
        .date-btn:hover { background: #333; border-color: #888; }
        .date-btn.active { background: #4a90e2; color: white; border-color: #8abeff; font-weight: bold; }
        .date-count { background: #c0392b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; }
        .leave-detail-panel { flex: 3; padding: 10px; background: rgba(30,30,30,0.5); overflow-y: auto; max-height: 600px; }
        .leave-card-v4 { display: flex; align-items: center; justify-content: space-between; background: #222; border: 1px solid #444; border-left: 4px solid #555; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .leave-job-badge { width: 80px; text-align: center; font-weight: bold; padding: 4px; border-radius: 4px; color: #000; margin-right: 15px; }
        .leave-name { font-size: 1.2em; font-weight: bold; width: 150px; }
        .leave-reason { color: #aaa; font-style: italic; flex-grow: 1; }
        .leave-force { color: #f1c40f; font-weight: bold; margin-left: 10px; font-size: 0.9em; }
        .time-cell { font-family: monospace; color: #8abeff; font-size: 0.9em; }
        
        /* å°éšŠ Grid ä½ˆå±€ */
        .activity-container { display: flex; gap: 20px; height: 600px; }
        .standby-panel { flex: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid #555; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .standby-list-content { overflow-y: auto; flex-grow: 1; }
        .member-card { display: flex; flex-direction: column; background: #2a2a2a; border: 1px solid #444; margin-bottom: 5px; padding: 8px; border-radius: 4px; }
        .member-card.disabled { opacity: 0.5; pointer-events: none; background: #111; border-color: #222; }
        .member-info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;}
        .member-detail-row { font-size: 0.85em; color: #888; display: flex; gap: 10px; }
        .force-badge { color: #f1c40f; font-weight: bold; }
        
        .squads-panel { flex: 3; display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: max-content; gap: 15px; overflow-y: auto; overflow-x: hidden; padding-bottom: 10px; align-items: start; padding-right: 5px; }
        .squad-box { width: auto; background: rgba(40, 40, 40, 0.9); border: 1px solid #cfaa70; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; transition: transform 0.2s; }
        .squad-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .squad-name-input { background: transparent; border: none; color: #ffde9e; font-weight: bold; font-size: 1.1em; width: 50%; }
        .squad-name-input:focus { border-bottom: 1px solid #cfaa70; outline: none; }
        .squad-controls { display: flex; gap: 2px; }
        .squad-list { flex-grow: 1; min-height: 100px; }
        .squad-member { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px dashed #444; font-size: 0.9em; }
        .remove-icon { color: #e74c3c; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .delete-tab-hint { font-size: 0.8em; color: #555; margin-left: 10px;}
    </style>
</head>
<body>

<div class="ro-panel">
    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="color: #cfaa70; font-weight: bold;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™åº«...</div>
    </div>

    <h2>âœ¦ RO å·¥æœƒç®¡ç†ç³»çµ± (é›²ç«¯å°ˆç”¨ç‰ˆ) âœ¦</h2>

    <div class="tab-container" id="tabContainer">
        <button class="tab-btn active" id="btn-memberTab" onclick="openTab('memberTab')">æˆå“¡åå–®</button>
        <button class="tab-btn" id="btn-queueTab" onclick="openTab('queueTab')">â³ æ’éšŠåå–®</button>
        <button class="tab-btn" id="btn-leaveTab" onclick="openTab('leaveTab')">å‡å–®å„€è¡¨æ¿</button>
        <button class="tab-btn tab-btn-add" onclick="createNewActivityTab()">+ æ–°å¢æ´»å‹•</button>
    </div>

    <div id="memberTab" class="tab-content active">
        <div class="stats-panel" id="memberStats">
            <div class="stat-badge stat-total">ç¸½äººæ•¸ï¼š0</div>
            </div>

        <div class="filter-bar" id="jobFilterContainer">
            <button class="filter-btn active" onclick="filterByJob('All')">å…¨éƒ¨é¡¯ç¤º</button>
        </div>
        <div class="input-group">
            <div class="input-item"><label>è§’è‰² ID</label><input type="text" id="mID" placeholder="ID" style="width: 120px;"></div>
            <div class="input-item"><label>è·æ¥­</label><select id="mJob"></select></div>
            <div class="input-item"><label>æˆ°åŠ›é †ä½</label><input type="number" id="mForce" class="force-input" placeholder="0" value="0"></div>
            <div class="input-item"><label>å‚™è¨»</label><input type="text" id="mNote" placeholder="å‚™è¨»"></div>
            <button class="ro-btn" onclick="addMember()">åŠ å…¥æˆå“¡</button>
            <button class="ro-btn" id="saveBtn" style="background: #e67e22; border-color: #d35400;" onclick="saveAllData()">â˜ é›²ç«¯å­˜æª”</button>
        </div>
        <div style="text-align:center; color:#e74c3c; font-size:0.9em; margin-bottom:10px;">
            âš ï¸ æ³¨æ„ï¼šæ‰€æœ‰ä¿®æ”¹è«‹å‹™å¿…æŒ‰ä¸‹ã€Œé›²ç«¯å­˜æª”ã€ï¼Œå¦å‰‡é‡æ–°æ•´ç†å¾Œè³‡æ–™å°‡æœƒéºå¤±ã€‚
        </div>
        <table id="guildTable">
            <thead>
                <tr>
                    <th onclick="sortTable('guildTable', 0)">ID</th><th onclick="sortTable('guildTable', 1)">è·æ¥­</th>
                    <th onclick="sortTable('guildTable', 2, true)" class="center-col">æˆ°åŠ›é †ä½</th>
                    <th onclick="sortTable('guildTable', 3)">å‚™è¨»</th><th class="center-col">ç®¡ç†</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="queueTab" class="tab-content">
        <div class="input-group" style="background:rgba(44, 62, 80, 0.6); border-color: #555;">
            <div class="input-item"><label>æ’éšŠ ID</label><input type="text" id="qID" placeholder="ID" style="width: 120px;"></div>
            <div class="input-item"><label>è·æ¥­</label><select id="qJob"></select></div>
            <div class="input-item"><label>æˆ°åŠ›é †ä½</label><input type="number" id="qForce" class="force-input" placeholder="0" value="0"></div>
            <div class="input-item"><label>å‚™è¨»</label><input type="text" id="qNote" placeholder="ä¾‹å¦‚: æœ‹å‹ä»‹ç´¹"></div>
            <button class="ro-btn" onclick="addToQueue()">åŠ å…¥æ’éšŠ</button>
        </div>
        
        <table id="queueTable">
            <thead>
                <tr>
                    <th>ID</th><th>è·æ¥­</th><th class="center-col">æˆ°åŠ›</th><th>å‚™è¨»</th><th class="center-col">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div style="text-align:center; color:#aaa; margin-top:10px;" id="queueEmptyHint">ç›®å‰ç„¡äººæ’éšŠ</div>
    </div>

    <div id="leaveTab" class="tab-content">
        <div class="input-group" style="background: rgba(44, 62, 80, 0.6); border-color: #555;">
            <div class="input-item">
                <label>é¸æ“‡æˆå“¡</label>
                <select id="leaveMemberSelect" style="width: 150px;"><option>è¼‰å…¥ä¸­...</option></select>
            </div>
            <div class="input-item">
                <label>è«‹å‡æ—¥æœŸ/æ™‚é–“</label>
                <input type="text" id="leaveTime" placeholder="ä¾‹: 2/3 æ™šä¸Š" style="width: 180px;">
            </div>
            <div class="input-item">
                <label>äº‹ç”±</label>
                <input type="text" id="leaveReason" placeholder="ä¾‹: åŠ ç­" style="width: 150px;">
            </div>
            <button class="ro-btn btn-submit-leave" id="btnSubmitLeave" onclick="submitLeave()">æäº¤å‡å–®</button>
            <button class="ro-btn btn-refresh" onclick="loadAllDataFromCloud()">âŸ³ åˆ·æ–°å‡å–®</button>
        </div>
        
        <div class="leave-dashboard" id="leaveDashboard">
            <div class="leave-date-list" id="leaveDateList"></div>
            <div class="leave-detail-panel">
                <h3 id="selectedDateTitle" style="color: #cfaa70; margin-top:0; border-bottom:1px solid #555; padding-bottom:10px;">è«‹é¸æ“‡å·¦å´æ—¥æœŸ</h3>
                <div id="leaveDetailContainer"></div>
            </div>
        </div>

        <div style="margin-top: 20px; text-align: right;">
            <button class="ro-btn btn-delete" style="font-size: 0.8em;" onclick="toggleRawLeaveData()">é¡¯ç¤ºåŸå§‹è³‡æ–™è¡¨ (é™¤éŒ¯ç”¨)</button>
        </div>
        <div id="rawLeaveTableContainer" style="display:none; margin-top:10px;">
             <table id="leaveTable"><thead><tr><th>ç³»çµ±æ™‚é–“</th><th>ID</th><th>è«‹å‡æ™‚é–“</th><th>äº‹ç”±</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
    
    <div id="dynamicContentContainer"></div>

</div>

<script>
    const DATA_SOURCE_URL = "https://script.google.com/macros/s/AKfycbx7i_ocU5mGIOK4oME1CwSm1oTaUG7R3BXs0YNBmDjXQHNMkDCHEwG1S0V52vDIASat/exec";

    const JOB_DATA = {
        "é¨å£«": "#e74c3c", "å·«å¸«": "#9b59b6", "çµäºº": "#2ecc71", "ç¥­å¸": "#00d2d3",
        "æ­¦é“å®¶": "#e67e22", "åˆºå®¢": "#ff9ff3", "éµåŒ ": "#95a5a6", "ç¥æ§æ‰‹": "#d35400",
        "åå­—è»": "#c0392b", "è³¢è€…": "#8e44ad", "åŸéŠ": "#27ae60", "èˆå­ƒ": "#16a085", "ç…‰é‡‘": "#7f8c8d", "æµæ°“": "#fd79a8"
    };

    let activityTabs = []; 
    let activityData = {}; 
    let squadNames = {}; 
    let leavesByDate = {};
    let waitingList = []; // æ–°å¢ï¼šæ’éšŠåå–®é™£åˆ—
    let isDataDirty = false; 

    window.onbeforeunload = function() {
        if (isDataDirty) return "æ‚¨æœ‰å°šæœªå„²å­˜çš„ä¿®æ”¹ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ";
    };

    window.onload = function() {
        initJobUI();      
        loadAllDataFromCloud(); 
    };

    function markDirty() {
        isDataDirty = true;
        document.getElementById("saveBtn").innerText = "â˜ é›²ç«¯å­˜æª” (æœªå„²å­˜)";
    }

    function loadAllDataFromCloud() {
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = "flex";

        fetch(DATA_SOURCE_URL + "?action=GET_ALL_DATA")
            .then(r => r.json())
            .then(data => {
                console.log("Cloud Data Received:", data);

                // 1. æˆå“¡åå–®
                let tbody = document.getElementById("guildTable").querySelector("tbody");
                tbody.innerHTML = "";
                if (data.members && Array.isArray(data.members)) {
                    data.members.forEach(m => insertMemberRow(m.id, m.job, m.force, m.note));
                }
                updateMemberStats(); // è¼‰å…¥å¾Œæ›´æ–°çµ±è¨ˆ

                // 2. æ’éšŠåå–® (æ–°å¢)
                waitingList = (data.queue && Array.isArray(data.queue)) ? data.queue : [];
                renderQueueTable();

                // 3. å‡å–®
                if (data.leaves && Array.isArray(data.leaves)) {
                    processLeaveData(data.leaves);
                } else {
                    leavesByDate = {}; 
                }
                renderLeaveDashboard();
                renderRawTable(data.leaves);

                // 4. æ´»å‹•åˆ†é 
                activityTabs = data.activityTabs || [];
                activityData = data.activityData || {};
                squadNames = data.squadNames || {}; 
                
                document.querySelectorAll(".tab-content[id^='act_']").forEach(e => e.remove());
                document.querySelectorAll(".tab-btn[id^='btn-act_']").forEach(e => e.remove());
                
                activityTabs.forEach(tab => {
                    createTabDOM(tab.id, tab.name);
                    let squadContainerId = tab.id + "_squads";
                    let standbyListId = tab.id + "_standby";
                    
                    if (activityData[tab.id]) {
                        for (let sqId in activityData[tab.id]) {
                            let sName = (squadNames[tab.id] && squadNames[tab.id][sqId]) ? squadNames[tab.id][sqId] : "å°éšŠ";
                            createSquadDOM(squadContainerId, sqId, sName);
                            renderSquadMembers(tab.id, sqId, standbyListId);
                        }
                    }
                    refreshStandbyList(standbyListId, tab.id);
                });
                
                updateLeaveMemberSelect();
                overlay.style.display = "none";
                isDataDirty = false;
                document.getElementById("saveBtn").innerText = "â˜ é›²ç«¯å­˜æª”";
            })
            .catch(err => {
                console.error("Load Error:", err);
                alert("è®€å–é›²ç«¯è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–ç¶²é  Consoleã€‚");
                overlay.innerHTML = "<div style='color:red'>é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>";
            });
    }

    function saveAllData() {
        let members = getMembersFromTable();
        
        // åŒæ­¥æ´»å‹•åˆ†é åç¨±
        activityTabs.forEach(tab => {
            if (!squadNames[tab.id]) squadNames[tab.id] = {};
            let container = document.getElementById(tab.id + "_squads");
            if (container) {
                let inputs = container.querySelectorAll(".squad-name-input");
                inputs.forEach(inp => {
                    let sqId = inp.closest(".squad-box").id;
                    squadNames[tab.id][sqId] = inp.value;
                });
            }
        });

        let saveBtn = document.getElementById("saveBtn");
        saveBtn.innerText = "ä¸Šå‚³ä¸­...";
        saveBtn.disabled = true;

        fetch(DATA_SOURCE_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                type: "SAVE_FULL_DATA", 
                members: members,
                activityTabs: activityTabs,
                activityData: activityData,
                squadNames: squadNames,
                queue: waitingList // æ–°å¢ï¼šåŒæ™‚å„²å­˜æ’éšŠåå–®
            })
        }).then(() => {
            setTimeout(() => {
                saveBtn.innerText = "å­˜æª”å®Œæˆ";
                isDataDirty = false;
                setTimeout(() => { saveBtn.innerText = "â˜ é›²ç«¯å­˜æª”"; saveBtn.disabled = false; }, 1000);
            }, 500);
        }).catch(err => {
            console.error(err);
            alert("é›²ç«¯å­˜æª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€ã€‚");
            saveBtn.innerText = "å­˜æª”å¤±æ•—";
            saveBtn.disabled = false;
        });
    }

    // --- æ’éšŠåå–®é‚è¼¯ (æ–°å¢) ---
    function addToQueue() {
        let id = document.getElementById("qID").value.trim();
        let job = document.getElementById("qJob").value;
        let force = document.getElementById("qForce").value;
        let note = document.getElementById("qNote").value;

        if (!id) return alert("è«‹è¼¸å…¥æ’éšŠ ID");
        // æª¢æŸ¥æ˜¯å¦å·²åœ¨æ’éšŠåå–®æˆ–æ­£å¼åå–® (ç°¡å–®æª¢æŸ¥)
        if (waitingList.some(q => q.id === id)) return alert("æ­¤ ID å·²åœ¨æ’éšŠä¸­");
        
        waitingList.push({ id: id, job: job, force: force, note: note });
        
        document.getElementById("qID").value = "";
        renderQueueTable();
        markDirty();
    }

    function renderQueueTable() {
        let tbody = document.getElementById("queueTable").querySelector("tbody");
        tbody.innerHTML = "";
        let hint = document.getElementById("queueEmptyHint");
        
        if (waitingList.length === 0) {
            hint.style.display = "block";
            return;
        } else {
            hint.style.display = "none";
        }

        waitingList.forEach((q, index) => {
            let tr = tbody.insertRow();
            let jobColor = JOB_DATA[q.job] || "#fff";
            tr.innerHTML = `
                <td>${q.id}</td>
                <td style="color:${jobColor}; font-weight:bold;">${q.job}</td>
                <td class="center-col">${q.force}</td>
                <td>${q.note}</td>
                <td class="center-col" style="display:flex; gap:5px; justify-content:center;">
                    <button class="ro-btn btn-promote" style="padding:4px 8px; font-size:0.8em;" onclick="promoteToMember(${index})">åŠ å…¥å…¬æœƒ</button>
                    <button class="ro-btn btn-delete" style="padding:4px 8px; font-size:0.8em;" onclick="removeFromQueue(${index})">åˆªé™¤</button>
                </td>
            `;
        });
    }

    function promoteToMember(index) {
        let person = waitingList[index];
        if(!confirm(`ç¢ºå®šè®“ã€Œ${person.id}ã€æ­£å¼åŠ å…¥å…¬æœƒå—ï¼Ÿ`)) return;

        // 1. åŠ å…¥æ­£å¼åå–®
        insertMemberRow(person.id, person.job, person.force, person.note);
        
        // 2. å¾æ’éšŠç§»é™¤
        waitingList.splice(index, 1);
        
        // 3. æ›´æ–°ä»‹é¢
        renderQueueTable();
        updateMemberStats();
        updateLeaveMemberSelect();
        filterByJob('All'); // åˆ‡æ›å›å…¨éƒ¨é¡¯ç¤ºä»¥å…çœ‹ä¸åˆ°æ–°äºº
        openTab('memberTab'); // è‡ªå‹•è·³è½‰å›æˆå“¡åˆ†é 
        markDirty();
        
        alert(`${person.id} å·²æˆåŠŸåŠ å…¥æˆå“¡åå–®ï¼`);
    }

    function removeFromQueue(index) {
        if(!confirm("ç¢ºå®šåˆªé™¤æ­¤æ’éšŠäººå“¡ï¼Ÿ")) return;
        waitingList.splice(index, 1);
        renderQueueTable();
        markDirty();
    }

    // --- æˆå“¡çµ±è¨ˆé‚è¼¯ (æ–°å¢) ---
    function updateMemberStats() {
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        let totalCount = 0;
        let jobCounts = {};

        // åˆå§‹åŒ–è·æ¥­è¨ˆæ•¸
        for (let job in JOB_DATA) { jobCounts[job] = 0; }

        rows.forEach(row => {
            if (row.style.display !== "none") { // åªçµ±è¨ˆå¯è¦‹çš„ (å¦‚æœæƒ³è¦çµ±è¨ˆå…¨éƒ¨ï¼Œå¯ç§»é™¤æ­¤åˆ¤æ–·ï¼Œä½†ç›®å‰ filter æ˜¯ç”¨ display none)
                // ä¿®æ­£ï¼šæ‡‰è©²çµ±è¨ˆæ‰€æœ‰æˆå“¡ï¼Œä¸å—ç¯©é¸å½±éŸ¿ï¼Œé™¤éä½¿ç”¨è€…å¸Œæœ›åªçœ‹ç¯©é¸å¾Œçš„çµ±è¨ˆ
                // é€™è£¡æ”¹ç‚ºçµ±è¨ˆã€Œç›®å‰è¡¨æ ¼å…§çš„æ‰€æœ‰è³‡æ–™ã€ï¼Œä¸å— filterByJob è¦–è¦ºéš±è—å½±éŸ¿
            }
            totalCount++;
            let job = row.getAttribute("data-job");
            if (jobCounts[job] !== undefined) {
                jobCounts[job]++;
            } else {
                // è™•ç†èˆŠè³‡æ–™å¯èƒ½æœ‰çš„ä¾‹å¤–è·æ¥­
                if(!jobCounts[job]) jobCounts[job] = 0;
                jobCounts[job]++;
            }
        });

        // æ¸²æŸ“
        let panel = document.getElementById("memberStats");
        let html = `<div class="stat-badge stat-total">ç¸½äººæ•¸ï¼š${totalCount}</div>`;
        
        for (let job in JOB_DATA) {
            if (jobCounts[job] > 0) {
                let color = JOB_DATA[job];
                html += `<div class="stat-badge" style="background:${color}; text-shadow:1px 1px 1px #000; color:#fff;">${job}ï¼š${jobCounts[job]}</div>`;
            }
        }
        panel.innerHTML = html;
    }

    // --- åŸæœ‰åŠŸèƒ½ç¶­æŒ ---
    
    function submitLeave() {
        let name = document.getElementById("leaveMemberSelect").value;
        let time = document.getElementById("leaveTime").value.trim();
        let reason = document.getElementById("leaveReason").value.trim();
        if(!name || name === "ç„¡æˆå“¡è³‡æ–™") return alert("è«‹å…ˆåœ¨æˆå“¡åå–®åˆ†é å»ºç«‹æˆå“¡ï¼");
        if(!time) return alert("è«‹è¼¸å…¥è«‹å‡æ™‚é–“");
        let btn = document.getElementById("btnSubmitLeave");
        btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";
        fetch(DATA_SOURCE_URL, {
            method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "SAVE_LEAVE", name: name, leaveTime: time, reason: reason })
        }).then(() => {
            setTimeout(() => {
                alert("å‡å–®å·²é€å‡ºï¼å³å°‡åˆ·æ–°...");
                document.getElementById("leaveTime").value = "";
                document.getElementById("leaveReason").value = "";
                btn.disabled = false; btn.innerText = "æäº¤å‡å–®";
                loadAllDataFromCloud();
            }, 1000);
        });
    }

    function deleteLeave(name, time, reason, btn) {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€åœ¨ã€Œ${time}ã€çš„å‡å–®å—ï¼Ÿ`)) return;
        btn.disabled = true; btn.innerText = "...";
        fetch(DATA_SOURCE_URL, {
            method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ type: "DELETE_LEAVE", name: name, leaveTime: time, reason: reason })
        }).then(() => {
            setTimeout(() => { alert("åˆªé™¤æŒ‡ä»¤å·²é€å‡ºï¼"); loadAllDataFromCloud(); }, 1000);
        }).catch(err => { alert("åˆªé™¤å¤±æ•—"); btn.disabled = false; btn.innerText = "åˆªé™¤"; });
    }

    function createNewActivityTab(defaultName = null) {
        let name = defaultName;
        if (!name) { name = prompt("æ–°æ´»å‹•åç¨±:"); if (!name) return; }
        let tabId = "act_" + new Date().getTime();
        activityTabs.push({ id: tabId, name: name });
        activityData[tabId] = {}; squadNames[tabId] = {};
        createTabDOM(tabId, name); markDirty();
    }

    function createTabDOM(tabId, name) {
        let btnContainer = document.getElementById("tabContainer");
        let addBtn = document.querySelector(".tab-btn-add");
        let newBtn = document.createElement("button");
        newBtn.className = "tab-btn"; newBtn.innerText = name; newBtn.id = "btn-" + tabId;
        newBtn.onclick = function() { openTab(tabId); };
        newBtn.ondblclick = function() { deleteTab(tabId, name); };
        btnContainer.insertBefore(newBtn, addBtn);
        let contentContainer = document.getElementById("dynamicContentContainer");
        let contentDiv = document.createElement("div");
        contentDiv.id = tabId; contentDiv.className = "tab-content";
        let squadContainerId = tabId + "_squads"; let standbyListId = tabId + "_standby";
        let jobOptions = `<option value="All">å…¨éƒ¨è·æ¥­</option>`;
        for(let j in JOB_DATA) { jobOptions += `<option value="${j}">${j}</option>`; }
        contentDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <button class="ro-btn btn-add-team" onclick="addNewSquad('${squadContainerId}')">+ æ–°å¢å°éšŠ</button>
                <span class="delete-tab-hint">æç¤ºï¼šé›™æ“Šåˆ†é å¯åˆªé™¤</span>
            </div>
            <div class="activity-container">
                <div class="standby-panel">
                    <div class="standby-header">
                        <div style="color:#ffde9e; font-weight:bold; margin-bottom:5px; text-align:center;">å¾…å‘½å€è¨­å®š</div>
                        <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                            <select id="filter_${tabId}" onchange="refreshStandbyList('${standbyListId}', '${tabId}')" style="width:120px; padding:4px;">${jobOptions}</select>
                            <label style="color:#ddd; cursor:pointer; font-size:0.9em; display:flex; align-items:center;">
                                <input type="checkbox" id="sort_${tabId}" onchange="refreshStandbyList('${standbyListId}', '${tabId}')"> é«˜æˆ°åŠ›å„ªå…ˆ
                            </label>
                        </div>
                    </div>
                    <div id="${standbyListId}" class="standby-list-content"></div>
                </div>
                <div class="squads-panel" id="${squadContainerId}"></div>
            </div>`;
        contentContainer.appendChild(contentDiv);
    }

    function refreshStandbyList(listId, tabId) {
        let listDiv = document.getElementById(listId); if (!listDiv) return;
        listDiv.innerHTML = "";
        let filterJob = document.getElementById(`filter_${tabId}`).value;
        let sortByForce = document.getElementById(`sort_${tabId}`).checked;
        let members = [];
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        rows.forEach(r => {
            let forceInput = r.querySelector(".force-input");
            members.push({ id: r.cells[0].innerText, job: r.cells[1].innerText, force: forceInput ? parseFloat(forceInput.value || 0) : 0, note: r.cells[3].innerText });
        });
        if (filterJob !== "All") members = members.filter(m => m.job === filterJob);
        if (sortByForce) members.sort((a, b) => b.force - a.force);
        let assignedIDs = [];
        let squads = activityData[tabId];
        for(let sqId in squads) { squads[sqId].forEach(m => assignedIDs.push(m.id)); }
        let squadContainer = document.getElementById(tabId + "_squads");
        let squadDivs = squadContainer ? squadContainer.getElementsByClassName("squad-box") : [];
        members.forEach(m => {
            let isAssigned = assignedIDs.includes(m.id);
            let jobColor = JOB_DATA[m.job] || "#fff";
            let card = document.createElement("div");
            card.className = "member-card" + (isAssigned ? " disabled" : "");
            let options = `<option value="">åŠ å…¥...</option>`;
            Array.from(squadDivs).forEach(sq => {
                 let sqNameInput = sq.querySelector(".squad-name-input");
                 let sqName = sqNameInput ? sqNameInput.value : "å°éšŠ";
                 options += `<option value="${sq.id}">${sqName}</option>`;
            });
            let forceText = (m.force > 0) ? `æˆ°:${m.force}` : "";
            card.innerHTML = `
                <div class="member-info-row">
                    <span><span class="job-text" style="color: ${jobColor}; font-size: 0.9em;">[${m.job}]</span> ${m.id}</span>
                    ${isAssigned ? '<span style="color:#555; font-size:0.8em;">(å·²å…¥éšŠ)</span>' : `<select onchange="addMemberToSquad(this, '${m.id}', '${m.job}', '${tabId}')" style="padding:2px; font-size:0.8em; width: 80px;">${options}</select>`}
                </div>
                <div class="member-detail-row">${forceText ? `<span class="force-badge">${forceText}</span>` : ''}<span>${m.note}</span></div>`;
            listDiv.appendChild(card);
        });
    }

    function createSquadDOM(containerId, sqId, name) {
        let container = document.getElementById(containerId); if (!container) return;
        let tabId = containerId.replace("_squads", "");
        let div = document.createElement("div"); div.className = "squad-box"; div.id = sqId;
        div.innerHTML = `
            <div class="squad-header">
                <input type="text" class="squad-name-input" value="${name}" onchange="markDirty(); refreshStandbyList('${tabId}_standby', '${tabId}');">
                <div class="squad-controls">
                    <button class="btn-move" title="å‘å·¦ç§»" onclick="moveSquad('${tabId}', '${sqId}', -1)">â†</button>
                    <button class="btn-move" title="å‘å³ç§»" onclick="moveSquad('${tabId}', '${sqId}', 1)">â†’</button>
                    <button class="ro-btn btn-delete" style="padding:2px 5px; margin-left:5px;" onclick="removeSquad('${tabId}', '${sqId}')">X</button>
                </div>
            </div>
            <div class="squad-list"></div>`;
        container.appendChild(div);
    }

    function addNewSquad(containerId, defaultName="æ–°å°éšŠ") {
        let tabId = containerId.replace("_squads", "");
        let sqId = "sq_" + new Date().getTime() + "_" + Math.floor(Math.random()*1000);
        if(!activityData[tabId]) activityData[tabId] = {}; 
        if(!activityData[tabId][sqId]) activityData[tabId][sqId] = [];
        if (!squadNames[tabId]) squadNames[tabId] = {};
        squadNames[tabId][sqId] = defaultName;
        createSquadDOM(containerId, sqId, defaultName); 
        markDirty(); refreshStandbyList(tabId + "_standby", tabId);
    }

    function addMemberToSquad(select, mId, mJob, tabId) {
        let sqId = select.value; if(!sqId) return;
        activityData[tabId][sqId].push({ id: mId, job: mJob });
        renderSquadMembers(tabId, sqId, tabId + "_standby"); refreshStandbyList(tabId + "_standby", tabId); markDirty();
    }
    
    function renderSquadMembers(tabId, sqId, listId) {
        let squadDiv = document.getElementById(sqId); if(!squadDiv) return;
        let listDiv = squadDiv.querySelector(".squad-list"); listDiv.innerHTML = "";
        let members = activityData[tabId][sqId];
        if (members) {
            members.forEach((m, index) => {
                let jobColor = JOB_DATA[m.job] || "#fff";
                let row = document.createElement("div"); row.className = "squad-member";
                let span = document.createElement("span");
                span.innerHTML = `<span style="color:${jobColor}; font-weight:bold;">${m.job}</span> `;
                let idText = document.createTextNode(" " + m.id);
                span.appendChild(idText);
                let btn = document.createElement("span");
                btn.className = "remove-icon";
                btn.innerText = "x";
                btn.onclick = function() { removeMemberFromSquad(tabId, sqId, index); };
                row.appendChild(span); row.appendChild(btn); listDiv.appendChild(row);
            });
        }
    }

    function removeMemberFromSquad(tabId, sqId, index) { 
        activityData[tabId][sqId].splice(index, 1); 
        renderSquadMembers(tabId, sqId, tabId + "_standby"); refreshStandbyList(tabId + "_standby", tabId); markDirty(); 
    }

    function removeSquad(tabId, sqId) { 
        if(!confirm("åˆªé™¤æ­¤å°éšŠï¼Ÿ")) return; 
        delete activityData[tabId][sqId]; 
        if (squadNames[tabId]) delete squadNames[tabId][sqId];
        document.getElementById(sqId).remove(); 
        refreshStandbyList(tabId + "_standby", tabId); markDirty(); 
    }

    function moveSquad(tabId, sqId, direction) {
        let squadsObj = activityData[tabId];
        let keys = Object.keys(squadsObj);
        let index = keys.indexOf(sqId);
        if (index === -1) return;
        let newIndex = index + direction;
        if (newIndex < 0 || newIndex >= keys.length) return; 
        let newSquadsObj = {};
        for (let i = 0; i < keys.length; i++) {
            let key = keys[i];
            if (i === index) key = keys[newIndex];
            else if (i === newIndex) key = keys[index];
            newSquadsObj[key] = squadsObj[key];
        }
        activityData[tabId] = newSquadsObj;
        let squadContainer = document.getElementById(tabId + "_squads");
        squadContainer.querySelectorAll(".squad-box").forEach(box => {
            if(!squadNames[tabId]) squadNames[tabId] = {};
            squadNames[tabId][box.id] = box.querySelector(".squad-name-input").value;
        });
        squadContainer.innerHTML = ""; 
        for(let k in newSquadsObj) {
            let name = (squadNames[tabId] && squadNames[tabId][k]) ? squadNames[tabId][k] : "å°éšŠ";
            createSquadDOM(squadContainer.id, k, name);
            renderSquadMembers(tabId, k, tabId + "_standby");
        }
        markDirty(); refreshStandbyList(tabId + "_standby", tabId);
    }

    function deleteTab(tabId, name) {
        if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
        document.getElementById("btn-" + tabId).remove(); document.getElementById(tabId).remove();
        activityTabs = activityTabs.filter(t => t.id !== tabId); 
        delete activityData[tabId]; delete squadNames[tabId];
        openTab('memberTab'); markDirty();
    }
    
    function openTab(tabId) {
        let contents = document.getElementsByClassName("tab-content");
        for (let c of contents) c.classList.remove("active");
        let btns = document.getElementsByClassName("tab-btn");
        for (let b of btns) b.classList.remove("active");
        let targetContent = document.getElementById(tabId);
        if (targetContent) targetContent.classList.add("active");
        let btn = document.getElementById("btn-" + tabId); if(btn) btn.classList.add("active");
        if (tabId === "leaveTab") { updateLeaveMemberSelect(); }
        if (tabId.startsWith("act_")) {
            let standbyListId = tabId + "_standby";
            refreshStandbyList(standbyListId, tabId);
        }
    }

    function insertMemberRow(id, job, force, note) {
        let tbody = document.getElementById("guildTable").querySelector("tbody"); 
        let row = tbody.insertRow(); row.setAttribute("data-job", job); 
        let jobColor = JOB_DATA[job] || "#fff";
        row.innerHTML = `<td contenteditable="true" class="editable" onfocus="this.dataset.old = this.innerText" onblur="updateMemberId(this)">${id}</td><td class="job-text" style="color: ${jobColor};">${job}</td><td class="center-col"><input type="number" class="force-input" value="${force}" onchange="markDirty()"></td><td contenteditable="true" class="editable" onblur="markDirty()">${note}</td><td class="center-col"><button class="ro-btn btn-delete" onclick="deleteRow(this); markDirty()">ç§»é™¤</button></td>`;
        updateMemberStats(); // æ›´æ–°çµ±è¨ˆ
    }
    
    function getMembersFromTable() {
        let members = [];
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        rows.forEach(r => {
            let forceInput = r.querySelector(".force-input");
            members.push({ id: r.cells[0].innerText, job: r.cells[1].innerText, force: forceInput ? forceInput.value : "0", note: r.cells[3].innerText });
        });
        return members;
    }
    
    function addMember() { 
        let id = document.getElementById("mID").value.trim(); 
        let job = document.getElementById("mJob").value; 
        let force = document.getElementById("mForce").value; 
        let note = document.getElementById("mNote").value; 
        if(id === "") return alert("è«‹è¼¸å…¥ ID"); 
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        for (let row of rows) { if (row.cells[0].innerText === id) { alert("éŒ¯èª¤ï¼šè©² ID å·²å­˜åœ¨ï¼"); return; } }
        insertMemberRow(id, job, force, note); 
        document.getElementById("mID").value = ""; filterByJob('All'); markDirty(); updateLeaveMemberSelect();
    }

    function updateMemberId(cell) {
        let oldId = cell.dataset.old; let newId = cell.innerText.trim();
        if (oldId === newId) return; 
        if (!oldId) { markDirty(); return; }
        updateLeaveMemberSelect();
        for (let tabId in activityData) {
            for (let sqId in activityData[tabId]) {
                let squad = activityData[tabId][sqId];
                squad.forEach(member => { if (member.id === oldId) { member.id = newId; } });
            }
        }
        markDirty(); 
    }
    
    function deleteRow(btn) { 
        let row = btn.closest("tr");
        let id = row.cells[0].innerText.trim();
        for (let tabId in activityData) {
            for (let sqId in activityData[tabId]) {
                activityData[tabId][sqId] = activityData[tabId][sqId].filter(m => m.id !== id);
            }
        }
        row.remove(); updateLeaveMemberSelect(); updateMemberStats(); // æ›´æ–°çµ±è¨ˆ
        
        let activeTab = document.querySelector(".tab-content.active");
        if (activeTab && activeTab.id.startsWith("act_")) { 
            let standbyId = activeTab.id + "_standby"; refreshStandbyList(standbyId, activeTab.id);
            for(let sqId in activityData[activeTab.id]) { renderSquadMembers(activeTab.id, sqId, standbyId); }
        }
    }

    function processLeaveData(data) {
        leavesByDate = {};
        if(!Array.isArray(data)) return;
        data.forEach(row => {
            if (!row || row.length < 4) return;
            let name = String(row[1]).trim();
            let timeStr = row[2] ? String(row[2]) : "";
            let reason = row[3] || "";
            let originalTimeStr = timeStr; 

            if (!timeStr) return;
            let dates = timeStr.split(/,|ï¼Œ/).map(d => d.trim()).filter(d => d.length > 0);
            dates.forEach(dateKey => {
                if(!leavesByDate[dateKey]) leavesByDate[dateKey] = [];
                let memberInfo = getMemberInfo(name);
                leavesByDate[dateKey].push({ 
                    name: name, reason: reason, 
                    job: memberInfo.job || "æœªçŸ¥", force: memberInfo.force || "", 
                    note: memberInfo.note || "", originalTime: originalTimeStr 
                });
            });
        });
    }

    function renderRawTable(data) {
        let tbody = document.getElementById("leaveTable").querySelector("tbody"); tbody.innerHTML = "";
        if(!Array.isArray(data)) return;
        data.forEach((row) => { 
            let tr = tbody.insertRow(); 
            let dateStr = "N/A";
            try {
                let d = new Date(row[0]);
                if (!isNaN(d.getTime())) dateStr = d.toLocaleDateString() + " " + d.toLocaleTimeString();
                else dateStr = row[0];
            } catch(e) { dateStr = row[0]; }
            tr.innerHTML = `<td class="time-cell">${dateStr}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td>`; 
        });
    }

    function renderLeaveDashboard() {
        const listContainer = document.getElementById("leaveDateList"); listContainer.innerHTML = "";
        const detailContainer = document.getElementById("leaveDetailContainer"); 
        let sortedDates = Object.keys(leavesByDate).sort();
        if (sortedDates.length === 0) { 
            listContainer.innerHTML = "<div style='padding:10px; color:#aaa; text-align:center;'>ç›®å‰ç„¡å‡å–®</div>"; 
            detailContainer.innerHTML = "<div style='padding:20px; color:#aaa; text-align:center;'>ç„¡è³‡æ–™é¡¯ç¤º</div>";
            document.getElementById("selectedDateTitle").innerText = "å‡å–®å„€è¡¨æ¿";
            return; 
        }
        sortedDates.forEach(date => {
            let count = leavesByDate[date].length;
            let btn = document.createElement("div"); btn.className = "date-btn";
            btn.onclick = function() { selectDate(this, date); };
            btn.innerHTML = `<span>${date}</span> <span class="date-count">${count}äºº</span>`;
            listContainer.appendChild(btn);
        });
        if (listContainer.firstChild) listContainer.firstChild.click();
    }
    
    function selectDate(btn, date) {
        let allBtns = document.querySelectorAll(".date-btn"); allBtns.forEach(b => b.classList.remove("active")); btn.classList.add("active");
        document.getElementById("selectedDateTitle").innerText = `ğŸ“… ${date} è«‹å‡åå–®`;
        const container = document.getElementById("leaveDetailContainer"); container.innerHTML = "";
        let list = leavesByDate[date];
        if(!list) return; 
        list.forEach(item => {
            let jobColor = JOB_DATA[item.job] || "#777"; let textColor = (item.job === "æœªçŸ¥") ? "#aaa" : "#000";
            let forceBadge = (item.force && item.force !== "0") ? `<span class="leave-force">â˜…æˆ°åŠ›:${item.force}</span>` : "";
            let card = document.createElement("div"); card.className = "leave-card-v4"; card.style.borderLeftColor = jobColor;
            let contentDiv = document.createElement("div");
            contentDiv.style.flex = "1"; contentDiv.style.display = "flex"; contentDiv.style.alignItems = "center";
            contentDiv.innerHTML = `<span class="leave-job-badge" style="background:${jobColor}; color:${textColor};">${item.job}</span><span class="leave-name">${item.name}</span>${forceBadge} <span class="leave-reason" style="margin-left:15px;">${item.reason}</span>`;
            let deleteBtn = document.createElement("button");
            deleteBtn.className = "btn-card-delete"; deleteBtn.innerText = "åˆªé™¤";
            deleteBtn.onclick = function() { deleteLeave(item.name, item.originalTime, item.reason, this); };
            card.appendChild(contentDiv); card.appendChild(deleteBtn);
            container.appendChild(card);
        });
    }

    function getMemberInfo(name) {
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        let searchName = name.trim().toLowerCase();
        for(let r of rows) {
            let rowName = r.cells[0].innerText.trim().toLowerCase();
            if (rowName === searchName) {
                let forceInput = r.querySelector(".force-input");
                return { job: r.cells[1].innerText, force: forceInput ? forceInput.value : "", note: r.cells[3].innerText };
            }
        }
        return { job: null, force: null, note: null };
    }

    function updateLeaveMemberSelect() {
        let select = document.getElementById("leaveMemberSelect");
        select.innerHTML = "";
        let members = getMembersFromTable();
        if (members.length === 0) { select.innerHTML = "<option>ç„¡æˆå“¡è³‡æ–™</option>"; return; }
        members.forEach(m => {
            let op = document.createElement("option"); op.value = m.id; op.text = m.id + " (" + m.job + ")"; select.appendChild(op);
        });
    }

    function initJobUI() {
        const select = document.getElementById("mJob"); const qSelect = document.getElementById("qJob");
        const filterContainer = document.getElementById("jobFilterContainer"); 
        select.innerHTML = ""; qSelect.innerHTML = "";
        for (let job in JOB_DATA) {
            let color = JOB_DATA[job]; 
            // æˆå“¡é é¢é¸å–®
            let option = document.createElement("option"); option.value = job; option.text = job; option.style.color = color; option.style.fontWeight = "bold"; 
            select.appendChild(option);
            // æ’éšŠé é¢é¸å–® (è¤‡è£½ä¸€ä»½)
            let qOption = option.cloneNode(true);
            qSelect.appendChild(qOption);

            let btn = document.createElement("button"); btn.className = "filter-btn"; btn.innerText = job; btn.style.borderColor = color;
            btn.onclick = function() { filterByJob(job); }; filterContainer.appendChild(btn);
        }
    }
    
    function filterByJob(targetJob) {
        let btns = document.querySelectorAll(".filter-btn");
        btns.forEach(b => { if (b.innerText === targetJob || (targetJob === 'All' && b.innerText === 'å…¨éƒ¨é¡¯ç¤º')) { b.classList.add("active"); if(targetJob !== 'All') { b.style.background = JOB_DATA[targetJob]; b.style.color = "#000"; } } else { b.classList.remove("active"); b.style.background = "#222"; b.style.color = "#888"; } });
        let trs = document.getElementById("guildTable").querySelectorAll("tbody tr"); trs.forEach(tr => { let rowJob = tr.getAttribute("data-job"); tr.style.display = (targetJob === 'All' || rowJob === targetJob) ? "" : "none"; });
    }

    function toggleRawLeaveData() { let div = document.getElementById("rawLeaveTableContainer"); div.style.display = (div.style.display === "none") ? "block" : "none"; }

    function sortTable(tableId, n, isNumber = false) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0; 
        table = document.getElementById(tableId); 
        switching = true; dir = "asc"; 
        while (switching) { 
            switching = false; rows = table.rows; 
            for (i = 1; i < (rows.length - 1); i++) { 
                shouldSwitch = false; 
                x = rows[i].getElementsByTagName("TD")[n]; 
                y = rows[i + 1].getElementsByTagName("TD")[n]; 
                let xVal = isNumber ? parseFloat(x.querySelector('input').value) : x.innerHTML.toLowerCase(); 
                let yVal = isNumber ? parseFloat(y.querySelector('input').value) : y.innerHTML.toLowerCase(); 
                if (dir == "asc") { if (xVal > yVal) { shouldSwitch = true; break; } } 
                else if (dir == "desc") { if (xVal < yVal) { shouldSwitch = true; break; } } 
            } 
            if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount ++; } 
            else { if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; } } 
        } 
    }
</script>
</body>
</html>