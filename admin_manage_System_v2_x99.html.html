<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RO å·¥æœƒç®¡ç†ç³»çµ± - é›²ç«¯ç‰ˆ (V2)</title>
    <style>
        /* --- å…¨åŸŸèˆ‡ RO é¢¨æ ¼ --- */
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #1a1a1a; background-image: radial-gradient(circle, #2c3e50, #000000); color: #e0e0e0; margin: 20px; }
        .ro-panel { background: rgba(30, 30, 30, 0.95); border: 2px solid #cfaa70; border-radius: 10px; padding: 20px; box-shadow: 0 0 15px rgba(207, 170, 112, 0.3); max-width: 1200px; margin: 0 auto; min-height: 700px; }
        h2 { color: #ffde9e; text-align: center; border-bottom: 1px solid #cfaa70; padding-bottom: 10px; margin-top: 0; }
        .tab-container { display: flex; margin-bottom: 20px; border-bottom: 2px solid #555; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; background: #2a2a2a; border: 1px solid #555; border-bottom: none; color: #aaa; cursor: pointer; font-weight: bold; border-radius: 5px 5px 0 0; margin-right: 5px; white-space: nowrap; }
        .tab-btn:hover { background: #333; color: #fff; }
        .tab-btn.active { background: #4a90e2; color: #fff; border-color: #8abeff; }
        .tab-btn-add { background: #2ecc71; color: #fff; border-color: #27ae60; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* è¼¸å…¥å€å¡Šæ¨£å¼ */
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; align-items: flex-end; border: 1px solid #444; }
        .input-item { display: flex; flex-direction: column; }
        label { font-size: 0.8em; color: #aaa; margin-bottom: 5px; }
        input[type="text"], input[type="number"], select { padding: 8px; background: #2a2a2a; border: 1px solid #555; color: #fff; border-radius: 4px; outline: none; }
        .force-input { width: 60px; text-align: center; background: #111; border: 1px solid #555; color: #ffde9e; font-weight: bold; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .ro-btn { padding: 8px 20px; background: linear-gradient(180deg, #4a90e2, #0056b3); color: white; border: 1px solid #8abeff; border-radius: 4px; cursor: pointer; font-weight: bold; min-width: 80px; }
        .ro-btn:hover { filter: brightness(1.1); }
        .ro-btn:disabled { background: #555; border-color: #444; color: #888; cursor: not-allowed; }
        .btn-delete { background: linear-gradient(180deg, #c0392b, #8e2a20); border-color: #e74c3c; }
        .btn-add-team { background: linear-gradient(180deg, #2ecc71, #27ae60); border-color: #2ecc71; margin-bottom: 10px;}
        .btn-move { padding: 2px 8px; background: #333; border: 1px solid #555; color: #fff; font-size: 0.8em; cursor: pointer; }
        .btn-submit-leave { background: linear-gradient(180deg, #f39c12, #d35400); border-color: #e67e22; color: #000; }
        
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #444; }
        .filter-btn { padding: 5px 12px; border: 1px solid #555; background: #222; color: #888; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
        .filter-btn.active { background: #cfaa70; color: #000; font-weight: bold; border-color: #fff; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; color: #ddd; }
        th { background: linear-gradient(180deg, #3d3d3d, #222); color: #ffde9e; padding: 12px; cursor: pointer; border-bottom: 2px solid #cfaa70; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #444; background: rgba(0, 0, 0, 0.2); vertical-align: middle; }
        .editable { cursor: text; }
        .editable:focus { background: #000; border: 1px solid #cfaa70; outline: none; }
        .center-col { text-align: center; }
        .job-text { font-weight: bold; text-shadow: 1px 1px 2px #000; }
        
        /* å‡å–®å°ˆç”¨ */
        .leave-dashboard { display: flex; gap: 20px; min-height: 500px; margin-top: 10px; }
        .leave-date-list { flex: 1; background: rgba(0,0,0,0.3); border-right: 1px solid #444; padding: 10px; overflow-y: auto; max-height: 600px; }
        .date-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 8px; background: #2a2a2a; border: 1px solid #444; color: #ddd; cursor: pointer; border-radius: 4px; transition: 0.2s; display: flex; justify-content: space-between; }
        .date-btn:hover { background: #333; border-color: #888; }
        .date-btn.active { background: #4a90e2; color: white; border-color: #8abeff; font-weight: bold; }
        .date-count { background: #c0392b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; }
        .leave-detail-panel { flex: 3; padding: 10px; background: rgba(30,30,30,0.5); overflow-y: auto; max-height: 600px; }
        .leave-card-v4 { display: flex; align-items: center; justify-content: space-between; background: #222; border: 1px solid #444; border-left: 4px solid #555; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .leave-job-badge { width: 80px; text-align: center; font-weight: bold; padding: 4px; border-radius: 4px; color: #000; margin-right: 15px; }
        .leave-name { font-size: 1.2em; font-weight: bold; width: 150px; }
        .leave-reason { color: #aaa; font-style: italic; flex-grow: 1; }
        .leave-force { color: #f1c40f; font-weight: bold; margin-left: 10px; font-size: 0.9em; }
        .error-box { padding: 20px; text-align: center; border: 1px dashed #e74c3c; color: #e74c3c; margin: 20px; display: none; }
        .time-cell { font-family: monospace; color: #8abeff; font-size: 0.9em; }
        
        /* å°éšŠå€å¡Š */
        .activity-container { display: flex; gap: 20px; height: 600px; }
        .standby-panel { flex: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid #555; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .standby-list-content { overflow-y: auto; flex-grow: 1; }
        .member-card { display: flex; flex-direction: column; background: #2a2a2a; border: 1px solid #444; margin-bottom: 5px; padding: 8px; border-radius: 4px; }
        .member-card.disabled { opacity: 0.5; pointer-events: none; background: #111; border-color: #222; }
        .member-info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;}
        .member-detail-row { font-size: 0.85em; color: #888; display: flex; gap: 10px; }
        .force-badge { color: #f1c40f; font-weight: bold; }
        .squads-panel { flex: 3; display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; align-items: flex-start; }
        .squad-box { min-width: 260px; background: rgba(40, 40, 40, 0.9); border: 1px solid #cfaa70; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; transition: transform 0.2s; }
        .squad-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .squad-name-input { background: transparent; border: none; color: #ffde9e; font-weight: bold; font-size: 1.1em; width: 50%; }
        .squad-name-input:focus { border-bottom: 1px solid #cfaa70; outline: none; }
        .squad-controls { display: flex; gap: 2px; }
        .squad-list { flex-grow: 1; min-height: 100px; }
        .squad-member { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px dashed #444; font-size: 0.9em; }
        .remove-icon { color: #e74c3c; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .delete-tab-hint { font-size: 0.8em; color: #555; margin-left: 10px;}
    </style>
</head>
<body>

<div class="ro-panel">
    <h2>âœ¦ RO å·¥æœƒç®¡ç†ç³»çµ± (é›²ç«¯ç‰ˆ v2) âœ¦</h2>

    <div class="tab-container" id="tabContainer">
        <button class="tab-btn active" id="btn-memberTab" onclick="openTab('memberTab')">æˆå“¡åå–®</button>
        <button class="tab-btn" id="btn-leaveTab" onclick="openTab('leaveTab')">å‡å–®å„€è¡¨æ¿</button>
        <button class="tab-btn tab-btn-add" onclick="createNewActivityTab()">+ æ–°å¢æ´»å‹•</button>
    </div>

    <div id="memberTab" class="tab-content active">
        <div class="filter-bar" id="jobFilterContainer">
            <button class="filter-btn active" onclick="filterByJob('All')">å…¨éƒ¨é¡¯ç¤º</button>
        </div>
        <div class="input-group">
            <div class="input-item"><label>è§’è‰² ID</label><input type="text" id="mID" placeholder="ID" style="width: 120px;"></div>
            <div class="input-item"><label>è·æ¥­</label><select id="mJob"></select></div>
            <div class="input-item"><label>æˆ°åŠ›é †ä½</label><input type="number" id="mForce" class="force-input" placeholder="0" value="0"></div>
            <div class="input-item"><label>å‚™è¨»</label><input type="text" id="mNote" placeholder="å‚™è¨»"></div>
            <button class="ro-btn" onclick="addMember()">åŠ å…¥æˆå“¡</button>
            <button class="ro-btn" id="saveBtn" style="background: #e67e22; border-color: #d35400;" onclick="saveAllData()">é›²ç«¯å­˜æª”</button>
        </div>
        <table id="guildTable">
            <thead>
                <tr>
                    <th onclick="sortTable('guildTable', 0)">ID</th><th onclick="sortTable('guildTable', 1)">è·æ¥­</th>
                    <th onclick="sortTable('guildTable', 2, true)" class="center-col">æˆ°åŠ›é †ä½</th>
                    <th onclick="sortTable('guildTable', 3)">å‚™è¨»</th><th class="center-col">ç®¡ç†</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="leaveTab" class="tab-content">
        <div class="input-group" style="background: rgba(44, 62, 80, 0.6); border-color: #555;">
            <div class="input-item">
                <label>é¸æ“‡æˆå“¡ (è«‹å…ˆå»ºç«‹åå–®)</label>
                <select id="leaveMemberSelect" style="width: 150px;"><option>è¼‰å…¥ä¸­...</option></select>
            </div>
            <div class="input-item">
                <label>è«‹å‡æ—¥æœŸ/æ™‚é–“</label>
                <input type="text" id="leaveTime" placeholder="ä¾‹: 2/3 æ™šä¸Š, 2/4 å…¨å¤©" style="width: 180px;">
            </div>
            <div class="input-item">
                <label>äº‹ç”±</label>
                <input type="text" id="leaveReason" placeholder="ä¾‹: åŠ ç­, èšé¤" style="width: 150px;">
            </div>
            <button class="ro-btn btn-submit-leave" id="btnSubmitLeave" onclick="submitLeave()">æäº¤å‡å–®</button>
        </div>

        <div id="loadingBox" style="text-align:center; padding: 20px; color: #aaa;">è³‡æ–™é€£ç·šä¸­...</div>
        <div id="errorBox" class="error-box">
            ç„¡æ³•è®€å–ç·šä¸Šè³‡æ–™ã€‚<br>è«‹ç¢ºèª Apps Script ç¶²å€æ˜¯å¦æ­£ç¢ºã€‚
        </div>
        
        <div class="leave-dashboard" id="leaveDashboard" style="display:none;">
            <div class="leave-date-list" id="leaveDateList"></div>
            <div class="leave-detail-panel">
                <h3 id="selectedDateTitle" style="color: #cfaa70; margin-top:0; border-bottom:1px solid #555; padding-bottom:10px;">è«‹é¸æ“‡å·¦å´æ—¥æœŸ</h3>
                <div id="leaveDetailContainer"></div>
            </div>
        </div>

        <div style="margin-top: 20px; text-align: right;">
            <button class="ro-btn btn-delete" style="font-size: 0.8em;" onclick="toggleRawLeaveData()">é¡¯ç¤ºåŸå§‹è³‡æ–™è¡¨</button>
        </div>
        <div id="rawLeaveTableContainer" style="display:none; margin-top:10px;">
             <table id="leaveTable"><thead><tr><th>ç³»çµ±æ™‚é–“</th><th>ID</th><th>è«‹å‡æ™‚é–“</th><th>äº‹ç”±</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
    
    <div id="dynamicContentContainer"></div>

</div>

<script>
    // â–¼â–¼â–¼ è«‹å‹™å¿…å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨æ›´æ–°ä¸¦ã€Œéƒ¨ç½²æ–°ç‰ˆæœ¬ã€å¾Œçš„ Apps Script ç¶²å€ â–¼â–¼â–¼
    const DATA_SOURCE_URL = "https://script.google.com/macros/s/AKfycbyo_llFwKnrejzal9uO-csOAF2riIUg7Gx8kRRy4XMt8puqPWSp0QGFtIhyfTJGg3FtzQ/exec";
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const JOB_DATA = {
        "é¨å£«": "#e74c3c", "å·«å¸«": "#9b59b6", "çµäºº": "#2ecc71", "ç¥­å¸": "#00d2d3",
        "æ­¦é“å®¶": "#e67e22", "åˆºå®¢": "#ff9ff3", "éµåŒ ": "#95a5a6", "ç¥æ§æ‰‹": "#d35400",
        "åå­—è»": "#c0392b", "è³¢è€…": "#8e44ad", "åŸéŠ": "#27ae60", "èˆå­ƒ": "#16a085", "ç…‰é‡‘": "#7f8c8d", "æµæ°“": "#fd79a8"
    };

    let activityTabs = []; 
    let activityData = {}; 
    let rawLeaveData = []; 
    let leavesByDate = {};

    window.onload = function() {
        initJobUI();      
        loadAllData(); // è®€å–æœ¬åœ°æˆå“¡
        fetchLeaveData(); // è®€å–é›²ç«¯å‡å–®
    };

    // --- å‡å–®æäº¤é‚è¼¯ (æ–°å¢) ---
    function updateLeaveMemberSelect() {
        let select = document.getElementById("leaveMemberSelect");
        select.innerHTML = "";
        let members = getMembersFromTable();
        if (members.length === 0) {
            select.innerHTML = "<option>ç„¡æˆå“¡è³‡æ–™</option>";
            return;
        }
        members.forEach(m => {
            let op = document.createElement("option");
            op.value = m.id;
            op.text = m.id + " (" + m.job + ")";
            select.appendChild(op);
        });
    }

    function submitLeave() {
        let name = document.getElementById("leaveMemberSelect").value;
        let time = document.getElementById("leaveTime").value.trim();
        let reason = document.getElementById("leaveReason").value.trim();
        
        if(!name || name === "ç„¡æˆå“¡è³‡æ–™") return alert("è«‹å…ˆåœ¨æˆå“¡åå–®åˆ†é å»ºç«‹æˆå“¡ï¼");
        if(!time) return alert("è«‹è¼¸å…¥è«‹å‡æ™‚é–“");
        
        let btn = document.getElementById("btnSubmitLeave");
        let originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "å‚³é€ä¸­...";

        fetch(DATA_SOURCE_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                type: "SAVE_LEAVE",
                name: name,
                time: time,
                reason: reason
            })
        }).then(() => {
            // å›  no-cors æ¨¡å¼ç„¡æ³•å¾—çŸ¥å›å‚³ï¼Œé€™è£¡åšå»¶é²é‡æ–°è®€å–
            setTimeout(() => {
                alert("å‡å–®å·²é€å‡ºï¼");
                document.getElementById("leaveTime").value = "";
                document.getElementById("leaveReason").value = "";
                btn.disabled = false;
                btn.innerText = originalText;
                fetchLeaveData(); // é‡æ–°æ•´ç†å‡å–®åˆ—è¡¨
            }, 1000);
        }).catch(err => {
            console.error(err);
            alert("å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Apps Script è¨­å®š");
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function createNewActivityTab(defaultName = null) {
        let name = defaultName;
        if (!name) { name = prompt("æ–°æ´»å‹•åç¨±:"); if (!name) return; }
        let tabId = "act_" + new Date().getTime();
        activityTabs.push({ id: tabId, name: name });
        activityData[tabId] = {}; 
        createTabDOM(tabId, name);
        saveLocalOnly(); 
    }

    function createTabDOM(tabId, name) {
        let btnContainer = document.getElementById("tabContainer");
        let addBtn = document.querySelector(".tab-btn-add");
        let newBtn = document.createElement("button");
        newBtn.className = "tab-btn"; newBtn.innerText = name; newBtn.id = "btn-" + tabId;
        newBtn.onclick = function() { openTab(tabId); };
        newBtn.ondblclick = function() { deleteTab(tabId, name); };
        btnContainer.insertBefore(newBtn, addBtn);

        let contentContainer = document.getElementById("dynamicContentContainer");
        let contentDiv = document.createElement("div");
        contentDiv.id = tabId; contentDiv.className = "tab-content";
        let squadContainerId = tabId + "_squads"; let standbyListId = tabId + "_standby";

        let jobOptions = `<option value="All">å…¨éƒ¨è·æ¥­</option>`;
        for(let j in JOB_DATA) { jobOptions += `<option value="${j}">${j}</option>`; }

        contentDiv.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <button class="ro-btn btn-add-team" onclick="addNewSquad('${squadContainerId}')">+ æ–°å¢å°éšŠ</button>
                <span class="delete-tab-hint">æç¤ºï¼šé›™æ“Šåˆ†é å¯åˆªé™¤</span>
            </div>
            <div class="activity-container">
                <div class="standby-panel">
                    <div class="standby-header">
                        <div style="color:#ffde9e; font-weight:bold; margin-bottom:5px; text-align:center;">å¾…å‘½å€è¨­å®š</div>
                        <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                            <select id="filter_${tabId}" onchange="refreshStandbyList('${standbyListId}', '${tabId}')" style="width:120px; padding:4px;">${jobOptions}</select>
                            <label style="color:#ddd; cursor:pointer; font-size:0.9em; display:flex; align-items:center;">
                                <input type="checkbox" id="sort_${tabId}" onchange="refreshStandbyList('${standbyListId}', '${tabId}')"> é«˜æˆ°åŠ›å„ªå…ˆ
                            </label>
                        </div>
                    </div>
                    <div id="${standbyListId}" class="standby-list-content"></div>
                </div>
                <div class="squads-panel" id="${squadContainerId}"></div>
            </div>`;
        contentContainer.appendChild(contentDiv);
    }

    function refreshStandbyList(listId, tabId) {
        let listDiv = document.getElementById(listId); if (!listDiv) return;
        listDiv.innerHTML = "";
        let filterJob = document.getElementById(`filter_${tabId}`).value;
        let sortByForce = document.getElementById(`sort_${tabId}`).checked;

        let members = [];
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        rows.forEach(r => {
            let forceInput = r.querySelector(".force-input");
            members.push({ id: r.cells[0].innerText, job: r.cells[1].innerText, force: forceInput ? parseFloat(forceInput.value || 0) : 0, note: r.cells[3].innerText });
        });

        if (filterJob !== "All") members = members.filter(m => m.job === filterJob);
        if (sortByForce) members.sort((a, b) => b.force - a.force);

        let assignedIDs = [];
        let squads = activityData[tabId];
        for(let sqId in squads) { squads[sqId].forEach(m => assignedIDs.push(m.id)); }
        
        let squadContainer = document.getElementById(tabId + "_squads");
        let squadDivs = squadContainer ? squadContainer.getElementsByClassName("squad-box") : [];

        members.forEach(m => {
            let isAssigned = assignedIDs.includes(m.id);
            let jobColor = JOB_DATA[m.job] || "#fff";
            let card = document.createElement("div");
            card.className = "member-card" + (isAssigned ? " disabled" : "");
            
            let options = `<option value="">åŠ å…¥...</option>`;
            Array.from(squadDivs).forEach(sq => {
                 let sqNameInput = sq.querySelector(".squad-name-input");
                 let sqName = sqNameInput ? sqNameInput.value : "å°éšŠ";
                 options += `<option value="${sq.id}">${sqName}</option>`;
            });

            let forceText = (m.force > 0) ? `æˆ°:${m.force}` : "";
            card.innerHTML = `
                <div class="member-info-row">
                    <span><span class="job-text" style="color: ${jobColor}; font-size: 0.9em;">[${m.job}]</span> ${m.id}</span>
                    ${isAssigned ? '<span style="color:#555; font-size:0.8em;">(å·²å…¥éšŠ)</span>' : `<select onchange="addMemberToSquad(this, '${m.id}', '${m.job}', '${tabId}')" style="padding:2px; font-size:0.8em; width: 80px;">${options}</select>`}
                </div>
                <div class="member-detail-row">${forceText ? `<span class="force-badge">${forceText}</span>` : ''}<span>${m.note}</span></div>`;
            listDiv.appendChild(card);
        });
    }

    function createSquadDOM(containerId, sqId, name) {
        let container = document.getElementById(containerId); if (!container) return;
        let tabId = containerId.replace("_squads", "");
        let div = document.createElement("div"); div.className = "squad-box"; div.id = sqId;
        div.innerHTML = `
            <div class="squad-header">
                <input type="text" class="squad-name-input" value="${name}" onchange="saveLocalOnly(); refreshStandbyList('${tabId}_standby', '${tabId}');">
                <div class="squad-controls">
                    <button class="btn-move" title="å‘å·¦ç§»" onclick="moveSquad('${tabId}', '${sqId}', -1)">â†</button>
                    <button class="btn-move" title="å‘å³ç§»" onclick="moveSquad('${tabId}', '${sqId}', 1)">â†’</button>
                    <button class="ro-btn btn-delete" style="padding:2px 5px; margin-left:5px;" onclick="removeSquad('${tabId}', '${sqId}')">X</button>
                </div>
            </div>
            <div class="squad-list"></div>`;
        container.appendChild(div);
    }

    function moveSquad(tabId, sqId, direction) {
        saveLocalOnly(); 
        let squadsObj = activityData[tabId];
        let keys = Object.keys(squadsObj);
        let index = keys.indexOf(sqId);
        if (index === -1) return;
        let newIndex = index + direction;
        if (newIndex < 0 || newIndex >= keys.length) return; 

        let newSquadsObj = {};
        for (let i = 0; i < keys.length; i++) {
            let key = keys[i];
            if (i === index) key = keys[newIndex];
            else if (i === newIndex) key = keys[index];
            newSquadsObj[key] = squadsObj[key];
        }
        activityData[tabId] = newSquadsObj;

        let squadContainer = document.getElementById(tabId + "_squads");
        let currentNames = {};
        squadContainer.querySelectorAll(".squad-box").forEach(box => {
            currentNames[box.id] = box.querySelector(".squad-name-input").value;
        });

        squadContainer.innerHTML = ""; 
        for(let k in newSquadsObj) {
            let name = currentNames[k] || "å°éšŠ";
            createSquadDOM(squadContainer.id, k, name);
            renderSquadMembers(tabId, k, tabId + "_standby");
        }
        saveLocalOnly();
        refreshStandbyList(tabId + "_standby", tabId);
    }

    function deleteTab(tabId, name) {
        if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
        document.getElementById("btn-" + tabId).remove(); document.getElementById(tabId).remove();
        activityTabs = activityTabs.filter(t => t.id !== tabId); delete activityData[tabId];
        openTab('memberTab'); saveLocalOnly();
    }
    
    function openTab(tabId) {
        let contents = document.getElementsByClassName("tab-content");
        for (let c of contents) c.classList.remove("active");
        let btns = document.getElementsByClassName("tab-btn");
        for (let b of btns) b.classList.remove("active");
        
        let targetContent = document.getElementById(tabId);
        if (targetContent) targetContent.classList.add("active");
        
        let btn = document.getElementById("btn-" + tabId); if(btn) btn.classList.add("active");

        if (tabId === "leaveTab") {
             updateLeaveMemberSelect(); // åˆ‡æ›åˆ°å‡å–®é æ™‚æ›´æ–°ä¸‹æ‹‰é¸å–®
        }

        if (tabId.startsWith("act_")) {
            let squadContainerId = tabId + "_squads"; let standbyListId = tabId + "_standby";
            let squads = activityData[tabId];
            let squadContainer = document.getElementById(squadContainerId);
            if(squadContainer && squadContainer.innerHTML === "") {
                let storedNames = JSON.parse(localStorage.getItem("ro_squad_names_v6") || "{}");
                let tabNames = storedNames[tabId] || {};
                for(let sqId in squads) {
                    let name = tabNames[sqId] || "å°éšŠ";
                    createSquadDOM(squadContainerId, sqId, name);
                    renderSquadMembers(tabId, sqId, standbyListId);
                }
            }
            refreshStandbyList(standbyListId, tabId);
        }
    }

    function addNewSquad(containerId, defaultName="æ–°å°éšŠ") {
        let tabId = containerId.replace("_squads", "");
        let sqId = "sq_" + new Date().getTime() + "_" + Math.floor(Math.random()*1000);
        if(!activityData[tabId]) activityData[tabId] = {}; 
        if(!activityData[tabId][sqId]) activityData[tabId][sqId] = [];
        createSquadDOM(containerId, sqId, defaultName); saveLocalOnly(); refreshStandbyList(tabId + "_standby", tabId);
    }

    function addMemberToSquad(select, mId, mJob, tabId) {
        let sqId = select.value; if(!sqId) return;
        activityData[tabId][sqId].push({ id: mId, job: mJob });
        renderSquadMembers(tabId, sqId, tabId + "_standby"); refreshStandbyList(tabId + "_standby", tabId); saveLocalOnly();
    }
    
    function renderSquadMembers(tabId, sqId, listId) {
        let squadDiv = document.getElementById(sqId); if(!squadDiv) return;
        let listDiv = squadDiv.querySelector(".squad-list"); listDiv.innerHTML = "";
        let members = activityData[tabId][sqId];
        members.forEach((m, index) => {
            let jobColor = JOB_DATA[m.job] || "#fff";
            let row = document.createElement("div"); row.className = "squad-member";
            let span = document.createElement("span");
            span.innerHTML = `<span style="color:${jobColor}; font-weight:bold;">${m.job}</span> `;
            let idText = document.createTextNode(" " + m.id);
            span.appendChild(idText);
            let btn = document.createElement("span");
            btn.className = "remove-icon";
            btn.innerText = "x";
            btn.onclick = function() { removeMemberFromSquad(tabId, sqId, index); };
            row.appendChild(span);
            row.appendChild(btn);
            listDiv.appendChild(row);
        });
    }

    function removeMemberFromSquad(tabId, sqId, index) { 
        activityData[tabId][sqId].splice(index, 1); renderSquadMembers(tabId, sqId, tabId + "_standby"); refreshStandbyList(tabId + "_standby", tabId); saveLocalOnly(); 
    }
    function removeSquad(tabId, sqId) { 
        if(!confirm("åˆªé™¤æ­¤å°éšŠï¼Ÿ")) return; delete activityData[tabId][sqId]; document.getElementById(sqId).remove(); refreshStandbyList(tabId + "_standby", tabId); saveLocalOnly(); 
    }

    function getMembersFromTable() {
        let members = [];
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        rows.forEach(r => {
            let forceInput = r.querySelector(".force-input");
            members.push({ id: r.cells[0].innerText, job: r.cells[1].innerText, force: forceInput ? forceInput.value : "0", note: r.cells[3].innerText });
        });
        return members;
    }

    function saveLocalOnly() {
        let members = getMembersFromTable();
        saveToLocalStorage(members);
    }

    function saveAllData() {
        let members = getMembersFromTable();
        saveToLocalStorage(members); 
        let saveBtn = document.getElementById("saveBtn");
        let originalText = saveBtn.innerText;
        saveBtn.innerText = "ä¸Šå‚³ä¸­...";
        saveBtn.disabled = true;

        fetch(DATA_SOURCE_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                type: "SAVE_MEMBERS", 
                members: members
            })
        }).then(() => {
            setTimeout(() => {
                saveBtn.innerText = "å­˜æª”å®Œæˆ";
                setTimeout(() => { saveBtn.innerText = originalText; saveBtn.disabled = false; }, 1000);
            }, 500);
        }).catch(err => {
            console.error(err);
            alert("é›²ç«¯å­˜æª”å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€ã€‚");
            saveBtn.innerText = originalText;
            saveBtn.disabled = false;
        });
    }

    function saveToLocalStorage(members) {
        let squadNames = {};
        activityTabs.forEach(tab => {
            squadNames[tab.id] = {};
            let container = document.getElementById(tab.id + "_squads");
            if(container) {
                let inputs = container.querySelectorAll(".squad-name-input");
                inputs.forEach(inp => {
                    let sqId = inp.closest(".squad-box").id;
                    squadNames[tab.id][sqId] = inp.value;
                });
            }
        });
        localStorage.setItem("ro_squad_names_v6", JSON.stringify(squadNames)); 
        let saveData = { members: members, activityTabs: activityTabs, activityData: activityData };
        localStorage.setItem("ro_guild_system_v3", JSON.stringify(saveData)); 
    }
    
    function loadAllData() {
        let json = localStorage.getItem("ro_guild_system_v3");
        if (!json) json = localStorage.getItem("ro_guild_system_v1");
        
        if (json) {
            let data = JSON.parse(json);
            activityTabs = data.activityTabs || [];
            activityData = data.activityData || {};
            activityTabs.forEach(tab => createTabDOM(tab.id, tab.name));
            
            // å˜—è©¦è®€å–é›²ç«¯æˆå“¡ï¼Œå¤±æ•—å‰‡ç”¨æœ¬åœ°
            fetch(DATA_SOURCE_URL + "?type=members")
                .then(r => r.json())
                .then(cloudMembers => {
                    if (cloudMembers && Array.isArray(cloudMembers) && cloudMembers.length > 0) {
                        renderMemberTable(cloudMembers);
                    } else if (data.members) {
                        renderMemberTable(data.members);
                    }
                })
                .catch(err => {
                    if(data.members) renderMemberTable(data.members);
                });

        } else {
            insertMemberRow("SkyWalker", "é¨å£«", 1, "ä¸»å¦");
            createNewActivityTab("åŸæˆ°é…ç½®");
        }
    }

    function renderMemberTable(members) {
        let tbody = document.getElementById("guildTable").querySelector("tbody");
        tbody.innerHTML = "";
        members.forEach(m => {
            let forceVal = (m.force === "æ˜¯") ? 1 : (m.force === "å¦" ? 0 : m.force);
            insertMemberRow(m.id, m.job, forceVal, m.note);
        });
        updateLeaveMemberSelect();
    }

    function fetchLeaveData() {
        const loading = document.getElementById("loadingBox"); 
        const errorBox = document.getElementById("errorBox"); 
        const dashboard = document.getElementById("leaveDashboard");
        loading.style.display = "block"; errorBox.style.display = "none";
        
        fetch(DATA_SOURCE_URL).then(r => r.json()).then(data => {
            loading.style.display = "none";
            rawLeaveData = data; 
            processLeaveData(data); 
            renderLeaveDashboard(); 
            renderRawTable(data); 
            dashboard.style.display = "flex"; 
        }).catch(err => { 
            loading.style.display = "none"; 
            errorBox.style.display = "block"; 
        });
    }
    
    function processLeaveData(data) {
        leavesByDate = {};
        if(!Array.isArray(data)) return;
        data.forEach(row => {
            // row: [timestamp, name, timeStr, reason]
            let name = row[1]; let timeStr = row[2]; let reason = row[3]; 
            // ç°¡å–®è™•ç†é€—è™Ÿåˆ†éš”çš„å¤šå€‹æ—¥æœŸ
            let dates = timeStr.split(/,|ï¼Œ/);
            dates.forEach(d => {
                let dateKey = d.trim();
                if(dateKey) {
                    if(!leavesByDate[dateKey]) leavesByDate[dateKey] = [];
                    let memberInfo = getMemberInfo(name);
                    leavesByDate[dateKey].push({ name: name, reason: reason, job: memberInfo.job || "æœªçŸ¥", force: memberInfo.force || "", note: memberInfo.note || "" });
                }
            });
        });
    }
    
    function getMemberInfo(name) {
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        for(let r of rows) {
            if (r.cells[0].innerText.trim() === name.trim()) {
                let forceInput = r.querySelector(".force-input");
                return { job: r.cells[1].innerText, force: forceInput ? forceInput.value : "", note: r.cells[3].innerText };
            }
        }
        return { job: null, force: null, note: null };
    }
    
    function renderLeaveDashboard() {
        const listContainer = document.getElementById("leaveDateList"); listContainer.innerHTML = "";
        let sortedDates = Object.keys(leavesByDate).sort();
        if (sortedDates.length === 0) { listContainer.innerHTML = "<div style='padding:10px; color:#aaa;'>ç›®å‰ç„¡å‡å–®</div>"; return; }
        sortedDates.forEach(date => {
            let count = leavesByDate[date].length;
            let btn = document.createElement("div"); btn.className = "date-btn";
            btn.onclick = function() { selectDate(this, date); };
            btn.innerHTML = `<span>${date}</span> <span class="date-count">${count}äºº</span>`;
            listContainer.appendChild(btn);
        });
        if (listContainer.firstChild) listContainer.firstChild.click();
    }
    
    function selectDate(btn, date) {
        let allBtns = document.querySelectorAll(".date-btn"); allBtns.forEach(b => b.classList.remove("active")); btn.classList.add("active");
        document.getElementById("selectedDateTitle").innerText = `ğŸ“… ${date} è«‹å‡åå–®`;
        const container = document.getElementById("leaveDetailContainer"); container.innerHTML = "";
        let list = leavesByDate[date];
        if(!list) return; 
        list.forEach(item => {
            let jobColor = JOB_DATA[item.job] || "#777"; let textColor = (item.job === "æœªçŸ¥") ? "#aaa" : "#000";
            let forceBadge = (item.force && item.force !== "0") ? `<span class="leave-force">â˜…æˆ°åŠ›:${item.force}</span>` : "";
            let card = document.createElement("div"); card.className = "leave-card-v4"; card.style.borderLeftColor = jobColor;
            card.innerHTML = `<div style="display:flex; align-items:center;"><span class="leave-job-badge" style="background:${jobColor}; color:${textColor};">${item.job}</span><span class="leave-name">${item.name}</span>${forceBadge}</div><span class="leave-reason">${item.reason}</span>`;
            container.appendChild(card);
        });
    }
    
    function toggleRawLeaveData() { let div = document.getElementById("rawLeaveTableContainer"); div.style.display = (div.style.display === "none") ? "block" : "none"; }
    
    function renderRawTable(data) {
        let tbody = document.getElementById("leaveTable").querySelector("tbody"); tbody.innerHTML = "";
        if(!Array.isArray(data)) return;
        data.forEach((row, index) => { 
            let tr = tbody.insertRow(); 
            // row[0] æ˜¯æ™‚é–“, row[1] ID, row[2] è«‹å‡æ™‚é–“, row[3] äº‹ç”±
            tr.innerHTML = `<td class="time-cell">${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td>`; 
        });
    }

    function initJobUI() {
        const select = document.getElementById("mJob"); const filterContainer = document.getElementById("jobFilterContainer"); select.innerHTML = ""; 
        for (let job in JOB_DATA) {
            let color = JOB_DATA[job]; let option = document.createElement("option"); option.value = job; option.text = job; option.style.color = color; option.style.fontWeight = "bold"; select.appendChild(option);
            let btn = document.createElement("button"); btn.className = "filter-btn"; btn.innerText = job; btn.style.borderColor = color;
            btn.onclick = function() { filterByJob(job); }; filterContainer.appendChild(btn);
        }
    }
    
    function filterByJob(targetJob) {
        let btns = document.querySelectorAll(".filter-btn");
        btns.forEach(b => { if (b.innerText === targetJob || (targetJob === 'All' && b.innerText === 'å…¨éƒ¨é¡¯ç¤º')) { b.classList.add("active"); if(targetJob !== 'All') { b.style.background = JOB_DATA[targetJob]; b.style.color = "#000"; } } else { b.classList.remove("active"); b.style.background = "#222"; b.style.color = "#888"; } });
        let trs = document.getElementById("guildTable").querySelectorAll("tbody tr"); trs.forEach(tr => { let rowJob = tr.getAttribute("data-job"); tr.style.display = (targetJob === 'All' || rowJob === targetJob) ? "" : "none"; });
    }
    
    function addMember() { 
        let id = document.getElementById("mID").value.trim(); 
        let job = document.getElementById("mJob").value; 
        let force = document.getElementById("mForce").value; 
        let note = document.getElementById("mNote").value; 
        if(id === "") return alert("è«‹è¼¸å…¥ ID"); 
        let rows = document.getElementById("guildTable").querySelectorAll("tbody tr");
        for (let row of rows) { if (row.cells[0].innerText === id) { alert("éŒ¯èª¤ï¼šè©² ID å·²å­˜åœ¨ï¼"); return; } }
        insertMemberRow(id, job, force, note); 
        document.getElementById("mID").value = ""; 
        filterByJob('All'); 
        saveLocalOnly(); 
        updateLeaveMemberSelect();
    }
    
    function insertMemberRow(id, job, force, note) {
        let tbody = document.getElementById("guildTable").querySelector("tbody"); let row = tbody.insertRow(); row.setAttribute("data-job", job); let jobColor = JOB_DATA[job] || "#fff";
        row.innerHTML = `<td contenteditable="true" class="editable" onfocus="this.dataset.old = this.innerText" onblur="updateMemberId(this)">${id}</td><td class="job-text" style="color: ${jobColor};">${job}</td><td class="center-col"><input type="number" class="force-input" value="${force}" onchange="saveLocalOnly()"></td><td contenteditable="true" class="editable" onblur="saveLocalOnly()">${note}</td><td class="center-col"><button class="ro-btn btn-delete" onclick="deleteRow(this); saveLocalOnly()">ç§»é™¤</button></td>`;
    }
    
    function updateMemberId(cell) {
        let oldId = cell.dataset.old; let newId = cell.innerText.trim();
        if (oldId === newId) return; 
        if (!oldId) { saveLocalOnly(); return; }
        // æ›´æ–°ä¸‹æ‹‰é¸å–®
        updateLeaveMemberSelect();
        // æ›´æ–°å°éšŠè³‡æ–™
        for (let tabId in activityData) {
            for (let sqId in activityData[tabId]) {
                let squad = activityData[tabId][sqId];
                squad.forEach(member => { if (member.id === oldId) { member.id = newId; } });
            }
        }
        let activeTab = document.querySelector(".tab-content.active");
        if (activeTab && activeTab.id.startsWith("act_")) { openTab(activeTab.id); }
        saveLocalOnly(); 
    }
    
    function deleteRow(btn) { 
        let row = btn.closest("tr");
        let id = row.cells[0].innerText.trim();
        for (let tabId in activityData) {
            for (let sqId in activityData[tabId]) {
                activityData[tabId][sqId] = activityData[tabId][sqId].filter(m => m.id !== id);
            }
        }
        row.remove(); 
        updateLeaveMemberSelect();
        let activeTab = document.querySelector(".tab-content.active");
        if (activeTab && activeTab.id.startsWith("act_")) { 
            let standbyId = activeTab.id + "_standby";
            refreshStandbyList(standbyId, activeTab.id);
            let squadContainer = document.getElementById(activeTab.id + "_squads");
            if(squadContainer) {
                 for(let sqId in activityData[activeTab.id]) {
                     renderSquadMembers(activeTab.id, sqId, standbyId);
                 }
            }
        }
    }

    function sortTable(tableId, n, isNumber = false) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0; 
        table = document.getElementById(tableId); 
        switching = true; dir = "asc"; 
        while (switching) { 
            switching = false; rows = table.rows; 
            for (i = 1; i < (rows.length - 1); i++) { 
                shouldSwitch = false; 
                x = rows[i].getElementsByTagName("TD")[n]; 
                y = rows[i + 1].getElementsByTagName("TD")[n]; 
                let xVal = isNumber ? parseFloat(x.querySelector('input').value) : x.innerHTML.toLowerCase(); 
                let yVal = isNumber ? parseFloat(y.querySelector('input').value) : y.innerHTML.toLowerCase(); 
                if (dir == "asc") { if (xVal > yVal) { shouldSwitch = true; break; } } 
                else if (dir == "desc") { if (xVal < yVal) { shouldSwitch = true; break; } } 
            } 
            if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount ++; } 
            else { if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; } } 
        } 
    }
</script>
</body>
</html>